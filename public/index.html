<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Detec√ß√£o de doen√ßas em plantas usando IA e c√¢mera">
  <meta name="theme-color" content="#4CAF50">
  
  <title>Detec√ß√£o de Doen√ßas em Plantas</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/icons/icon-192.png">
  
  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      padding: 30px 20px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 14px;
    }
    
    .content {
      padding: 20px;
    }
    
    .status {
      text-align: center;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
    }
    
    .status.loading {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    .status.error {
      background: #ffebee;
      color: #c62828;
    }
    
    .status.success {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .video-container {
      position: relative;
      width: 100%;
      background: #000;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 20px;
      aspect-ratio: 4/3;
    }
    
    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }
    
    #video.active {
      display: block;
    }
    
    .video-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #999;
      font-size: 16px;
    }
    
    #video.active + .video-placeholder {
      display: none;
    }
    
    canvas {
      display: none;
    }
    
    .controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    button {
      padding: 15px 20px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      background: #4CAF50;
      color: white;
    }
    
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
    }
    
    button:active:not(:disabled) {
      transform: translateY(0);
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    button.secondary {
      background: #2196F3;
    }
    
    button.danger {
      background: #f44336;
    }
    
    button.warning {
      background: #ff9800;
    }
    
    .result-container {
      background: #f5f5f5;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      min-height: 150px;
    }
    
    .result-container.hidden {
      display: none;
    }
    
    .result-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
      color: #333;
    }
    
    .result-item {
      margin-bottom: 12px;
    }
    
    .result-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
    }
    
    .result-value {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }
    
    .confidence-bar {
      width: 100%;
      height: 30px;
      background: #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
      margin-top: 10px;
    }
    
    .confidence-fill {
      height: 100%;
      background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
    }
    
    .health-status {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      margin-top: 10px;
    }
    
    .health-status.healthy {
      background: #4CAF50;
      color: white;
    }
    
    .health-status.disease {
      background: #f44336;
      color: white;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .continuous-mode {
      margin-top: 10px;
      text-align: center;
    }
    
    .continuous-mode label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
      font-size: 14px;
    }
    
    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üåø Detec√ß√£o de Doen√ßas em Plantas</h1>
      <p>Use sua c√¢mera para identificar doen√ßas em plantas</p>
    </div>
    
    <div class="content">
      <div id="status" class="status loading">
        <span class="loading-spinner"></span>
        Carregando modelo...
      </div>
      
      <div class="video-container">
        <video id="video" autoplay playsinline></video>
        <div class="video-placeholder">
          Clique em "Iniciar C√¢mera" para come√ßar
        </div>
      </div>
      
      <canvas id="canvas"></canvas>
      
      <div class="controls">
        <button id="btnStartCamera" class="secondary">Iniciar C√¢mera</button>
        <button id="btnStopCamera" class="danger" disabled>Parar C√¢mera</button>
        <button id="btnCapture" disabled>Capturar Foto</button>
        <button id="btnSwitchCamera" class="warning" disabled>Trocar C√¢mera</button>
      </div>
      
      <div class="continuous-mode">
        <label>
          <input type="checkbox" id="continuousMode">
          Modo Cont√≠nuo (detec√ß√£o autom√°tica)
        </label>
      </div>
      
      <div id="resultContainer" class="result-container hidden">
        <div class="result-title">Resultado da Detec√ß√£o</div>
        
        <div class="result-item">
          <div class="result-label">Doen√ßa Detectada:</div>
          <div class="result-value" id="resultDisease">-</div>
        </div>
        
        <div class="result-item">
          <div class="result-label">Planta:</div>
          <div class="result-value" id="resultPlant">-</div>
        </div>
        
        <div class="result-item">
          <div class="result-label">Confian√ßa:</div>
          <div class="confidence-bar">
            <div class="confidence-fill" id="confidenceFill" style="width: 0%">0%</div>
          </div>
        </div>
        
        <div id="healthStatus" class="health-status" style="display: none;"></div>
      </div>
    </div>
  </div>
  
  <script type="module">
    import { loadModel } from '/src/model-loader.js';
    import { preprocessVideoFrame } from '/src/preprocess.js';
    import { loadClassNames, predict, formatClassName } from '/src/inference.js';
    import { initCamera, stopCamera, captureFrame, switchCamera, isCameraAvailable } from '/src/camera.js';
    
    // Elementos DOM
    const statusEl = document.getElementById('status');
    const videoEl = document.getElementById('video');
    const canvasEl = document.getElementById('canvas');
    const btnStartCamera = document.getElementById('btnStartCamera');
    const btnStopCamera = document.getElementById('btnStopCamera');
    const btnCapture = document.getElementById('btnCapture');
    const btnSwitchCamera = document.getElementById('btnSwitchCamera');
    const continuousModeCheckbox = document.getElementById('continuousMode');
    const resultContainer = document.getElementById('resultContainer');
    const resultDisease = document.getElementById('resultDisease');
    const resultPlant = document.getElementById('resultPlant');
    const confidenceFill = document.getElementById('confidenceFill');
    const healthStatus = document.getElementById('healthStatus');
    
    // Estado da aplica√ß√£o
    let model = null;
    let isCameraActive = false;
    let isContinuousMode = false;
    let continuousModeInterval = null;
    let lastInferenceTime = 0;
    const INFERENCE_THROTTLE_MS = 500; // Throttle de 500ms entre infer√™ncias
    
    // Fun√ß√µes auxiliares
    function updateStatus(message, type = 'loading') {
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
    }
    
    function showResult(result) {
      const formatted = formatClassName(result.className);
      
      resultDisease.textContent = formatted.disease;
      resultPlant.textContent = formatted.plant;
      
      const confidencePercent = Math.round(result.confidence * 100);
      confidenceFill.style.width = `${confidencePercent}%`;
      confidenceFill.textContent = `${confidencePercent}%`;
      
      if (formatted.isHealthy) {
        healthStatus.textContent = '‚úì Planta Saud√°vel';
        healthStatus.className = 'health-status healthy';
        healthStatus.style.display = 'block';
      } else {
        healthStatus.textContent = '‚ö† Doen√ßa Detectada';
        healthStatus.className = 'health-status disease';
        healthStatus.style.display = 'block';
      }
      
      resultContainer.classList.remove('hidden');
    }
    
    async function performInference() {
      if (!model || !isCameraActive || videoEl.readyState !== videoEl.HAVE_ENOUGH_DATA) {
        return;
      }
      
      const now = Date.now();
      if (now - lastInferenceTime < INFERENCE_THROTTLE_MS) {
        return;
      }
      lastInferenceTime = now;
      
      try {
        // Capturar frame
        captureFrame(videoEl, canvasEl, 224, 224);
        
        // Pr√©-processar
        const preprocessed = preprocessVideoFrame(videoEl);
        
        // Infer√™ncia
        const result = await predict(model, preprocessed);
        
        // Limpar tensor
        preprocessed.dispose();
        
        // Exibir resultado
        showResult(result);
        
      } catch (error) {
        console.error('Erro na infer√™ncia:', error);
        updateStatus('Erro ao processar imagem', 'error');
      }
    }
    
    function startContinuousMode() {
      if (continuousModeInterval) {
        clearInterval(continuousModeInterval);
      }
      
      continuousModeInterval = setInterval(() => {
        if (isContinuousMode && isCameraActive) {
          performInference();
        }
      }, INFERENCE_THROTTLE_MS);
    }
    
    function stopContinuousMode() {
      if (continuousModeInterval) {
        clearInterval(continuousModeInterval);
        continuousModeInterval = null;
      }
    }
    
    // Event Listeners
    btnStartCamera.addEventListener('click', async () => {
      if (!isCameraAvailable()) {
        updateStatus('C√¢mera n√£o dispon√≠vel neste dispositivo', 'error');
        return;
      }
      
      try {
        updateStatus('Iniciando c√¢mera...', 'loading');
        await initCamera(videoEl);
        
        isCameraActive = true;
        videoEl.classList.add('active');
        btnStartCamera.disabled = true;
        btnStopCamera.disabled = false;
        btnCapture.disabled = false;
        btnSwitchCamera.disabled = false;
        
        updateStatus('C√¢mera ativa - Pronto para capturar', 'success');
        
        if (isContinuousMode) {
          startContinuousMode();
        }
        
      } catch (error) {
        updateStatus(error.message, 'error');
      }
    });
    
    btnStopCamera.addEventListener('click', () => {
      stopCamera();
      isCameraActive = false;
      videoEl.classList.remove('active');
      btnStartCamera.disabled = false;
      btnStopCamera.disabled = true;
      btnCapture.disabled = true;
      btnSwitchCamera.disabled = true;
      
      stopContinuousMode();
      updateStatus('C√¢mera parada', 'loading');
    });
    
    btnCapture.addEventListener('click', () => {
      performInference();
    });
    
    btnSwitchCamera.addEventListener('click', async () => {
      try {
        updateStatus('Trocando c√¢mera...', 'loading');
        await switchCamera(videoEl);
        updateStatus('C√¢mera trocada', 'success');
      } catch (error) {
        updateStatus(error.message, 'error');
      }
    });
    
    continuousModeCheckbox.addEventListener('change', (e) => {
      isContinuousMode = e.target.checked;
      
      if (isContinuousMode && isCameraActive) {
        startContinuousMode();
      } else {
        stopContinuousMode();
      }
    });
    
    // Inicializa√ß√£o
    async function init() {
      try {
        // Carregar nomes das classes
        await loadClassNames();
        
        // Carregar modelo
        updateStatus('Carregando modelo TensorFlow.js...', 'loading');
        model = await loadModel('/web_model_tfjs/model.json', (progress) => {
          updateStatus(`Carregando modelo... ${progress}%`, 'loading');
        });
        
        updateStatus('Modelo carregado! Clique em "Iniciar C√¢mera"', 'success');
        
      } catch (error) {
        console.error('Erro na inicializa√ß√£o:', error);
        updateStatus(`Erro: ${error.message}`, 'error');
      }
    }
    
    // Registrar Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('Service Worker registrado:', reg))
          .catch(err => console.error('Erro ao registrar Service Worker:', err));
      });
    }
    
    // Iniciar aplica√ß√£o
    init();
  </script>
</body>
</html>
